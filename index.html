<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Amazonギフト管理（メール＋パスワード）</title>
<style>
body { font-family: sans-serif; padding:20px; background:#f4f4f4; font-size:18px; }
#auth,#main { max-width:500px; margin:auto; background:white; padding:20px; border-radius:15px; box-shadow:0 4px 10px rgba(0,0,0,0.15); }
button { width:100%; padding:16px; margin-top:12px; font-size:20px; background:#000; color:white; border:none; border-radius:10px; cursor:pointer; }
input { width:100%; padding:14px; margin-top:12px; font-size:18px; border-radius:8px; border:1px solid #ccc; box-sizing:border-box; }
.gift-item { background:#fff; padding:12px; margin-top:12px; border-radius:10px; border:1px solid #ddd; }
.gift-code { font-size:22px; color:#0066ff; cursor:pointer; word-break:break-all; }
</style>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.27.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.27.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.27.0/firebase-firestore-compat.js"></script>
</head>
<body>

<div id="auth">
    <h2>メールアドレスでログイン / 新規登録</h2>
    <input type="email" id="email" placeholder="メールアドレス">
    <input type="password" id="password" placeholder="パスワード">
    <button type="button" onclick="login()">ログイン / 登録</button>
</div>

<div id="main" style="display:none;">
    <button type="button" onclick="logout()">ログアウト</button>
    <h2>ギフトコード管理</h2>

    <input type="text" id="search" placeholder="検索（例：10円・2025・コード）" oninput="loadList()">
    <input id="amount" type="text" placeholder="金額">
    <input id="limit" type="date">
    <input id="code" type="text" placeholder="ギフトコード">
    <button type="button" onclick="addCode()">追加</button>

    <div id="list"></div>
</div>

<script>
// ====== Firebase 設定 ======
const firebaseConfig = {
  apiKey: "AIzaSyAG0Yk_EiQPkEWhN_5Uog28lLkt35JjuVs",
  authDomain: "login-34ff3.firebaseapp.com",
  projectId: "login-34ff3",
  storageBucket: "login-34ff3.firebasestorage.app",
  messagingSenderId: "782026139390",
  appId: "1:782026139390:web:0bda935de829c8272467af",
  measurementId: "G-0X2Q3EG34Q"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// ログイン / 登録
function login() {
    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value;
    if(!email||!password){alert("メールとパスワードを入力してください"); return;}

    auth.signInWithEmailAndPassword(email,password)
        .then(()=>{showMain();})
        .catch(err=>{
            if(err.code==="auth/user-not-found"){
                // 新規登録
                auth.createUserWithEmailAndPassword(email,password)
                    .then(()=>{showMain();})
                    .catch(e=>alert("登録失敗: "+e.message));
            }else{
                alert("ログイン失敗: "+err.message);
            }
        });
}

// メイン表示
function showMain(){
    document.getElementById("auth").style.display="none";
    document.getElementById("main").style.display="block";
    loadList();
}

// ログアウト
function logout(){
    auth.signOut();
    document.getElementById("auth").style.display="block";
    document.getElementById("main").style.display="none";
    document.getElementById("list").innerHTML="";
    document.getElementById("email").value="";
    document.getElementById("password").value="";
}

// ギフトコード追加
function addCode(){
    const user = auth.currentUser;
    if(!user) return;
    const amount = document.getElementById("amount").value;
    const limit = document.getElementById("limit").value;
    const code = document.getElementById("code").value;
    if(!amount||!limit||!code){alert("全て入力してください"); return;}

    db.collection("codes").add({
        uid:user.uid,
        amount,
        limit,
        code,
        timestamp:firebase.firestore.FieldValue.serverTimestamp()
    }).then(()=>{
        document.getElementById("amount").value="";
        document.getElementById("limit").value="";
        document.getElementById("code").value="";
        loadList();
    });
}

// リスト読み込み（検索対応）
function loadList(){
    const user = auth.currentUser;
    if(!user) return;
    const keyword = document.getElementById("search").value.toLowerCase();
    db.collection("codes").where("uid","==",user.uid)
      .orderBy("timestamp","desc").get()
      .then(snapshot=>{
          const list=document.getElementById("list");
          list.innerHTML="";
          snapshot.forEach(doc=>{
              const data=doc.data();
              if(data.amount.toLowerCase().includes(keyword)||
                 data.limit.toLowerCase().includes(keyword)||
                 data.code.toLowerCase().includes(keyword)){
                     const div=document.createElement("div");
                     div.className="gift-item";
                     div.innerHTML=`
                        <p>金額: ${data.amount}</p>
                        <p>期限: ${data.limit}</p>
                        <p class="gift-code" onclick="copyCode('${data.code}')">${data.code}</p>
                        <button type="button" onclick="deleteCode('${doc.id}')">削除</button>
                     `;
                     list.appendChild(div);
                 }
          });
      });
}

// コード削除
function deleteCode(id){
    db.collection("codes").doc(id).delete().then(()=>loadList());
}

// コピー + バイブ
function copyCode(text){
    navigator.clipboard.writeText(text);
    if(navigator.vibrate) navigator.vibrate(100);
    alert("コピーしました！");
}

// Auth 状態監視
auth.onAuthStateChanged(user=>{
    if(user) showMain();
});
</script>

</body>
</html>
